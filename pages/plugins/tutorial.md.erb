# Plugin Tutorial

In this tutorial we'll create a Buildkite plugin called "File Counter", which counts the number of files in the build directory once the command has finished, and creates a build annotation with that number. The API we're aiming for looks like the following:

```yml
steps:
  - command: ...
    plugins:
      a-github-user/file-counter#v1.0.0:
        name: '*.md'
```

{:toc}

## Create a new git repository

Every Buildkite plugin is a Git repository, ending in `-buildkite-plugin`. Let's create a new Git repository following these naming conventions:

```shell
mkdir file-counter-buildkite-plugin
cd file-counter-buildkite-plugin
git init
```

## Add a plugin.yml

Next we'll create the first file: a `plugin.yml` file. This describes how it will appear in the [Buildkite Plugin Directory](/docs/plugins/directory).

```shell
touch plugin.yml
```

```yaml
name: File Counter
description: Annotates the build with a file count
author: https://github.com/a-github-user
requirements: []
configuration:
  pattern:
    name: string
  additionalProperties: false
```

The `configuration` property defines the validation rules for the plugin configuration using the [JSON Schema](https://json-schema.org) format. We’ve specified that the plugin has a single `name` property, of type `string`.

## Add a hook

Plugins can implement a number of [plugin hooks](/docs/agent/v3/hooks). For this plugin, we’ll create a `post-command` hook in a `hooks` directory:

```shell
mkdir hooks
touch hooks/post-command
chmod +x hooks/post-command
```

```shell
#!/bin/bash
set -euo pipefail

PATTERN="$BUILDKITE_PLUGIN_FILE_COUNTER_PATTERN"

echo "--- :1234: Counting the number of files"

COUNT=$(find . -name "$PATTERN" | wc -l)

echo "Found ${COUNT} files matching ${PATTERN}"

buildkite-agent annotate "Found ${COUNT} files matching ${PATTERN}"
```

## Add a test

Next step is to test the `post-command` hook using BATS, and the the `buildkite/plugin-tester` Docker image.

```shell
mkdir tests
touch tests/post-command.bats
chmod +x tests/post-command.bats
```

Create the following `tests/post-command.bats` file:

```shell
#!/usr/bin/env bats

load '/usr/local/lib/bats/load.bash'

@test "Creates an annotation with the file count" {
  export BUILDKITE_PLUGIN_FILE_COUNTER_PATTERN="*.bats"

  stub buildkite-agent annotate "Found 1 files matching *.bats"

  run "$PWD/hooks/post-command"

  unstub buildkite-agent

  assert_success
  assert_output --partial "Found 1 files matching *.bats"
}
```

To run the test, run the following Docker command:

```shell
docker run -it --rm -v "$(PWD):/plugin:ro" buildkite/plugin-tester
```

```
 ✓ Creates an annotation with the file count

1 test, 0 failures
```

To make it easier to run this command, create a Docker Compose file:

```shell
touch docker-compose.yml
```

```yml
version: '2'
services:
  tests:
    image: buildkite/plugin-tester
    volumes:
      - ".:/plugin:ro"
```

You can now run the tests using the following command:

```shell
docker-compose run --rm tests
```

## Add a readme

Next we'll add a `README.md` file to introduce the plugin to the world:

```shell
touch README.md
```

~~~markdown
# File Counter Buildkite Plugin

Annotates the build with a file count.

## Example

```yml
steps:
  - command: ...
    plugins:
      a-github-user/file-counter#v1.0.0:
        name: '*.md'
```

## Configuration

### `name` (Required, string)

The file name pattern, for example `*.ts`. Supports any pattern supported by [find -name](http://man7.org/linux/man-pages/man1/find.1.html).

## Developing

To run the tests:

```shell
docker-compose run --rm tests
```

## Contributing

1. Fork the repo
2. Make the changes
3. Run the tests
4. Commit and push your changes
5. Send a pull request
~~~

## Add the linter

The Buildkite Plugin Linter helps ensure your plugin is up-to-date, and has all the required files to be listed in the plugin directory.

You can run the plugin linter with the following Docker command:

```shell
docker run -it --rm -v "$(PWD):/plugin:ro" buildkite/plugin-linter --id a-github-user/file-counter
```

To make it easier to run this command, add it to the `docker-compose.yml` file:

```yml
services:
  tests: ...
  lint:
    image: buildkite/plugin-linter
    command: ['--id', 'a-github-user/file-counter']
    volumes:
      - ".:/plugin:ro"
```

You can now run the tests using the following command:

```shell
docker-compose run --rm linter
```

## Publish to the directory

To add your plugin to the [Buildkite Plugin Directory](/docs/plugins/directory), publish your repository to a public GitHub repository and add the `buildkite-plugin` repository topic tag.

<section class="Docs__troubleshooting-note">
  <p>Before publishing, make sure that all your tests are passing and that the plugin linter does not output any errors, otherwise it may not appear on the directory.</p>
</section>

## Further reading

* 
* 