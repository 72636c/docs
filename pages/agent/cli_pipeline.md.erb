# buildkite-agent pipeline

The Buildkite Agent’s `pipeline` command allows you to add and replace build steps in the running build. The steps are defined using YML or JSON and can be read from a file or streamed from the output of a script.

See the [Uploading Build Pipelines](/docs/pipelines/uploading-pipelines) guide for a step-by-step example.

<%= toc %>

## Uploading pipelines

```
Usage:

   buildkite-agent pipeline upload <file> [arguments...]

Description:

   Allows you to change the pipeline of a running build by uploading either a
   JSON or YAML configuration file. If no configuration file is provided,
   we look for the file in the following locations:

   - .buildkite/pipeline.yml
   - .buildkite/pipeline.json

   You can also pipe build pipelines to the command, allowing you to create scripts
   that generate dynamic pipelines.

Example:

   $ buildkite-agent pipeline upload
   $ buildkite-agent pipeline upload my-custom-steps.json
   $ ./script/dynamic_step_generator | buildkite-agent pipeline upload

Options:

   --replace                                    Replace the rest of the existing pipeline with the steps uploaded. Jobs that are already running are not removed. [$BUILDKITE_PIPELINE_REPLACE]
   --job                                        The job that is making the changes to it's build [$BUILDKITE_JOB_ID]
   --agent-access-token                         The access token used to identify the agent [$BUILDKITE_AGENT_ACCESS_TOKEN]
   --endpoint "https://agent.buildkite.com/v3"  The Agent API endpoint [$BUILDKITE_AGENT_ENDPOINT]
   --no-color                                   Don't show colors in logging [$BUILDKITE_AGENT_NO_COLOR]
   --debug                                      Enable debug mode [$BUILDKITE_AGENT_DEBUG]
   --debug-http                                 Enable HTTP debug mode, which dumps all request and response bodies to the log [$BUILDKITE_AGENT_DEBUG_HTTP]
```

## Pipeline format

The pipeline can be written as YAML or JSON, but YAML is more commonly for its readability. There are two top level properties you can specify:

* `env` - A map of <a href="/docs/builds/environment-variables">environment variables</a> to apply to all steps
* `steps` - An list of [build pipeline steps](/docs/pipelines/defining-steps)

## Environment variable substitution

The `pipeline upload` command in Buildkite Agent versions 3.0 and above supports environment variable substitution using the syntax `$VAR` and `${VAR}`.

For example, the following pipeline substitutes a number of [Buildkite’s default environment variables](/docs/builds/environment-variables) into a [trigger step](/docs/pipelines/trigger-step):

```yml
- command: "$BUILDKITE_PIPELINE_SLUG-deploy"
  label: "\:rocket\:"
  branches: "master"
  async: true
  build:
    message: "$BUILDKITE_MESSAGE"
    commit: "$BUILDKITE_COMMIT"
    branch: "$BUILDKITE_BRANCH"
```

### Default values

If an environment variable has not been set its default value will be a blank string. You can set your own default value using the syntax `${VAR:-default}`.

For example, the following step will run the command `deploy.sh staging` if the `DEPLOY_ENV` environment variable has not been set or is blank (i.e. `""`):

```yaml
- command: "deploy.sh \"${DEPLOY_ENV:-staging}\""
```

If you need to substitute blank values (i.e. `""`) you can use the syntax `${VAR-default}`.

For example, if the `DEPLOY_ENV` environment variable is set to `""` the following step will run the command `deploy.sh ""`, and if it has not been set it will run the command `deploy.sh "staging"`:

```yaml
- command: "deploy.sh \"${DEPLOY_ENV-staging}\""
```

### Character ranges

You can substitute a range of characters from an environment variable by specifying a start and end position using the syntax `${VAR:start:end}`.

For example, the following step will echo the first 7 characters of the `BUILDKITE_COMMIT` environment variable:

```yaml
- command: "echo ${BUILDKITE_COMMIT:0:7}"
```

If the environment variable has not been set, the range will return a blank string.

### Buildkite Agent 2.x support

If you want to use environment variable substitution, but are unable to update your Buildkite Agent to version 3.0 or above, it is possible (but not recommended) to emulate the behavior using your shell’s built-in environment variable substitution:

```shell
echo $(eval echo $(cat pipeline.yml)) | buildkite-agent pipeline upload
```