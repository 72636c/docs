# AWS EventBridge

Buildkiteâ€™s [AWS EventBridge](https://aws.amazon.com/eventbridge/) notification service lets you subscribe, in real-time, to Buildkite events from your AWS account.

<%= toc %>

## Configuring

(click buttons in BK)

(configure AWS)

## Events

The following events will be published to the configured event source:

<table>
<thead>
  <tr><th>Event</th><th>Description</th></tr>
</thead>
<tbody>
  <tr><th><a href="#events-build-scheduled">Build Scheduled</a></th><td><%= webhook_description "build.scheduled" %></td></tr>
  <tr><th><a href="#events-build-running">Build Running</a></th><td><%= webhook_description "build.running" %></td></tr>
  <tr><th><a href="#events-build-finished">Build Finished</a></th><td><%= webhook_description "build.finished" %></td></tr>
  <tr><th><a href="#events-job-scheduled">Job Scheduled</a></th><td><%= webhook_description "job.scheduled" %></td></tr>
  <tr><th><a href="#events-job-started">Job Started</a></th><td><%= webhook_description "job.started" %></td></tr>
  <tr><th><a href="#events-job-finished">Job Finished</a></th><td><%= webhook_description "job.finished" %></td></tr>
  <tr><th><a href="#events-job-activated">Job Activated</a></th><td><%= webhook_description "job.activated" %></td></tr>
  <tr><th><a href="#events-agent-connected">Agent Connected</a></th><td><%= webhook_description "agent.connected" %></td></tr>
  <tr><th><a href="#events-agent-lost">Agent Lost</a></th><td><%= webhook_description "agent.lost" %></td></tr>
  <tr><th><a href="#events-agent-disconnected">Agent Disconnected</a></th><td><%= webhook_description "agent.disconnected" %></td></tr>
  <tr><th><a href="#events-agent-stopping">Agent Stopping</a></th><td><%= webhook_description "agent.stopping" %></td></tr>
  <tr><th><a href="#events-agent-stopped">Agent Stopped</a></th><td><%= webhook_description "agent.stopped" %></td></tr>
</tbody>
</table>

## Example: Logging events with CloudWatch Logs

You can use following [AWS Lambda](https://docs.aws.amazon.com/lambda/latest/dg/welcome.html) as a rule target, which will log events to [CloudWatch Logs](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html):

```js
exports.handler = (event, context, callback) => {
  console.log("Received event", JSON.stringify(event));
  callback(null, "Finished");
};
```

## Example: Tracking agent wait time with CloudWatch Metrics

You can use following [AWS Lambda](https://docs.aws.amazon.com/lambda/latest/dg/welcome.html) as a rule target, which will publish a [CloudWatch metric](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/working_with_metrics.html) which tracks how long jobs are waiting for agents to become available:

```js
const AWS = require("aws-sdk");
const cloudWatch = new AWS.CloudWatch();

exports.handler = (event, context, callback) => {
  if (event["detail-type"] != "Job Started") {
    callback(null, "Finished");
    return;
  }

  const waitTime =
    new Date(event.detail.job.started_at) -
    new Date(event.detail.job.runnable_at);

  console.log(`Job started after waiting ${waitTime} seconds`);

  cloudWatch.putMetricData(
    {
      Namespace: "Buildkite",
      MetricData: [
        {
          MetricName: "Job Agent Wait Time",
          Timestamp: new Date(),
          StorageResolution: 1,
          Unit: "Seconds",
          Value: waitTime,
          Dimensions: [
            {
              Name: "Pipeline",
              Value: event.detail.pipeline.slug
            }
          ]
        }
      ]
    },
    (err, data) => {
      if (err) console.log(err, err.stack);
      callback(null, "Finished");
    }
  );
};
```

## Event Payloads

<h3 id="events-build-created">Build Created</h3>

```json
{
}
```

<h3 id="events-build-started">Build Started</h3>

```json
{
}
```

<h3 id="events-build-skipped">Build Skipped</h3>

```json
{
}
```

<h3 id="events-build-finished">Build Finished</h3>

```json
{
}
```

<h3 id="events-job-scheduled">Job Scheduled</h3>

```json
{
}
```

<h3 id="events-job-started">Job Started</h3>

```json
{
}
```

<h3 id="events-job-finished">Job Finished</h3>

```json
{
}
```

<h3 id="events-job-activated">Job Activated</h3>

```json
{
}
```

<h3 id="events-agent-connected">Agent Connected</h3>

```json
{
  "detail": {
    "version": 1,
    "agent": {
      "uuid": "288139c5-728d-4c22-88e3-5a926b6c4a51",
      "graphql_id": "QWdlbnQtLS0yODgxMzljNS03MjhkLTRjMjItODhlMy01YTkyNmI2YzRhNTE=",
      "connection_state": "connected",
      "name": "my-agent-1",
      "version": "3.13.2",
      "ip_address": "3.80.193.183",
      "hostname": "ip-10-0-2-73.ec2.internal",
      "pid": "18534",
      "priority": 0,
      "meta_data": [
        "aws:instance-id=i-0ce2c738afbfc6c83"
      ],
      "connected_at": "2019-08-10 09:44:40 UTC",
      "disconnected_at": null,
      "lost_at": null
    },
    "organization": {
      "uuid": "a98961b7-adc1-41aa-8726-cfb2c46e42e0",
      "graphql_id": "T3JnYW5pemF0aW9uLS0tYTk4OTYxYjctYWRjMS00MWFhLTg3MjYtY2ZiMmM0NmU0MmUw",
      "slug": "my-org"
    }
  }
}
```

<h3 id="events-agent-disconnected">Agent Disconnected</h3>

```json
{
  "version": 1,
  "agent": {
    "uuid": "288139c5-728d-4c22-88e3-5a926b6c4a51",
    "graphql_id": "QWdlbnQtLS0yODgxMzljNS03MjhkLTRjMjItODhlMy01YTkyNmI2YzRhNTE=",
    "connection_state": "disconnected",
    "name": "my-agent-1",
    "version": "3.13.2",
    "ip_address": "3.80.193.183",
    "hostname": "ip-10-0-2-73.ec2.internal",
    "pid": "18534",
    "priority": 0,
    "meta_data": [
      "aws:instance-id=i-0ce2c738afbfc6c83"
    ],
    "connected_at": "2019-08-10 09:44:40 UTC",
    "disconnected_at": "2019-08-10 09:54:40 UTC",
    "lost_at": null
  },
  "organization": {
    "uuid": "a98961b7-adc1-41aa-8726-cfb2c46e42e0",
    "graphql_id": "T3JnYW5pemF0aW9uLS0tYTk4OTYxYjctYWRjMS00MWFhLTg3MjYtY2ZiMmM0NmU0MmUw",
    "slug": "my-org"
  }
}
```

<h3 id="events-agent-lost">Agent Lost</h3>

```json
{
  "version": 1,
  "agent": {
    "uuid": "288139c5-728d-4c22-88e3-5a926b6c4a51",
    "graphql_id": "QWdlbnQtLS0yODgxMzljNS03MjhkLTRjMjItODhlMy01YTkyNmI2YzRhNTE=",
    "connection_state": "lost",
    "name": "my-agent-1",
    "version": "3.13.2",
    "ip_address": "3.80.193.183",
    "hostname": "ip-10-0-2-73.ec2.internal",
    "pid": "18534",
    "priority": 0,
    "meta_data": [
      "aws:instance-id=i-0ce2c738afbfc6c83"
    ],
    "connected_at": "2019-08-10 09:44:40 UTC",
    "disconnected_at": "2019-08-10 09:54:40 UTC",
    "lost_at": "2019-08-10 09:54:40 UTC"
  },
  "organization": {
    "uuid": "a98961b7-adc1-41aa-8726-cfb2c46e42e0",
    "graphql_id": "T3JnYW5pemF0aW9uLS0tYTk4OTYxYjctYWRjMS00MWFhLTg3MjYtY2ZiMmM0NmU0MmUw",
    "slug": "my-org"
  }
}
```

<h3 id="events-agent-stopping">Agent Stopping</h3>

```json
{
  "version": 1,
  "agent": {
    "uuid": "288139c5-728d-4c22-88e3-5a926b6c4a51",
    "graphql_id": "QWdlbnQtLS0yODgxMzljNS03MjhkLTRjMjItODhlMy01YTkyNmI2YzRhNTE=",
    "connection_state": "stopping",
    "name": "my-agent-1",
    "version": "3.13.2",
    "ip_address": "3.80.193.183",
    "hostname": "ip-10-0-2-73.ec2.internal",
    "pid": "18534",
    "priority": 0,
    "meta_data": [
      "aws:instance-id=i-0ce2c738afbfc6c83"
    ],
    "connected_at": "2019-08-10 09:44:40 UTC",
    "disconnected_at": null,
    "lost_at": null
  },
  "organization": {
    "uuid": "a98961b7-adc1-41aa-8726-cfb2c46e42e0",
    "graphql_id": "T3JnYW5pemF0aW9uLS0tYTk4OTYxYjctYWRjMS00MWFhLTg3MjYtY2ZiMmM0NmU0MmUw",
    "slug": "my-org"
  }
}
```

<h3 id="events-agent-stopped">Agent Stopped</h3>

```json
{
  "version": 1,
  "agent": {
    "uuid": "288139c5-728d-4c22-88e3-5a926b6c4a51",
    "graphql_id": "QWdlbnQtLS0yODgxMzljNS03MjhkLTRjMjItODhlMy01YTkyNmI2YzRhNTE=",
    "connection_state": "stopped",
    "name": "my-agent-1",
    "version": "3.13.2",
    "ip_address": "3.80.193.183",
    "hostname": "ip-10-0-2-73.ec2.internal",
    "pid": "18534",
    "priority": 0,
    "meta_data": [
      "aws:instance-id=i-0ce2c738afbfc6c83"
    ],
    "connected_at": "2019-08-10 09:44:40 UTC",
    "disconnected_at": "2019-08-10 09:54:40 UTC",
    "lost_at": null
  },
  "organization": {
    "uuid": "a98961b7-adc1-41aa-8726-cfb2c46e42e0",
    "graphql_id": "T3JnYW5pemF0aW9uLS0tYTk4OTYxYjctYWRjMS00MWFhLTg3MjYtY2ZiMmM0NmU0MmUw",
    "slug": "my-org"
  }
}
```