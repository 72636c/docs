# Phabricator

[Phabricator][] can trigger Buildkite on new revisions or commits through Habormaster.

<%= toc %>

## Prerequisites

Check that your repository is activated in your Phabricator instance. Configure
a pipeline for the repository in Buildkite. You also need admin accces in your
Phabricator and your Buildkite organization. Also install the Harbormaster and
Herald applications on your phabricator instance.

## Step 1: New Phabricator Build Step

First, create a new Build Plan in Harbormaster. Inside Habormaster open "Manage
Build Plans". Press "Create Build Plan" in the upper right.

<%= image "phabricator_create_build_plan.png", alt: "Creating a new Build Plan in Phabricator" %>

Provide a name then press "Create Build Plan".

Next, add a step to the Build Plan. A "Build Step" calls one BuildKite
"pipeline". If you need to call multiple pipelines then create multiple Build
Steps.

<%= image "phabricator_run_in_buildkite.png", alt: "Selecting Builkite for this Build Step" %>

Press "Add Build Step" on the next screen. Then select "Build with Buildkite".

<%= image "phabricator_blank_build_step.png", alt: "Incomplete Build Step" %>

Keep this screen open while you configure Buildkite.

## Step 2: Configure Buildkite Notification Webhook

Phabricator and Buildkite integrate via webhooks. Phabricator triggers events
in Buildkite, then Buildkite reports the status. You need to create an API
Access Token in Buildkite to configure Phabricator.

Open the [New API Access
Token](https://buildkite.com/user/api-access-tokens/new) page in Buildkite.
Provide a description, then select the relevant organization. Check
`read_builds` and `write_builds`. Create the token then save a copy on the next screen.

<%= image "buildkite_new_api_access_token.png", alt: "Creating a new Buildkite API Access Token" %>

Next, configure the "Webhook Notification" for your Buildkite organization.

From Phabrictor use the "Webhook URL" under "Webhook Configuration" (it should
end in `/harbormaster/hook/buildkite/`) for "Webhook URL" in Buildkite.  Make a
note of the autogenerated value in the "Token" field in Buildkite.  Check
`build.finished` under Events, then save the notification settings.

<%= image "buildkite_notification_webhook_settings.png", alt: "Buildkite Notification Webhook settings" %>

Now back to Phabricator.

## Step 3: Complete Phabricator Build Step

Press "Add New Credential" for "API Token". Provide a name and use the
Buildkite API Access Token generated in earlier for the "Token" field.

<%= image "phabricator_new_credential.png", alt: "Creating a new Credential in Phabricator" %>

Fill in the Buildkite "Organization Name" and "Pipeline Name". Use the Token
from Builkite's Notfication Webhook for "Webhook Token" in Phabricator. Both
should have the same value.

<%= image "phabricator_build_step.png", alt: "Completing the Phabricator Build Step" %>

Finally press "Create Build Step".

## Step 4: Test with Manual Build

Click "Run Plan Manually" on the next screen. Provide a revision ID for the repository inside Phabricator.

<%= image "phabricator_manual_build_trigger.png", alt: "Run a manual build in Phabricator" %>

Next, your Buildkite Pipeline should run then report back to Phabricator.

<%= image "phabricator_build_status.png", alt: "Build status in Phabricator" %>
<%= image "buildkite_pipeline.png", alt: "Build status in Phabricator" %>

[phabricator]: https://phacility.com/phabricator/
