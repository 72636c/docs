# SAML with Active Directory Federation Services (AD FS)

- Teams using AD FS can use it to log into Buildkite

## Setting up your AD FS Server

- you must be an admin in your Buildkite organisation, and have __ permissions on the server you're using for AD FS
- know the slug of the Buildkite organisation for which you'd like to enable SSO 

## Setup in the AD FS management console

using a series of wizards, you'll:
- add a 'relying party trust' and
- add an 'issuance transform rule', a type of 'claim rule'
- export the token-signing certificate
- update the authentication policy


- this guide was written for and tested using Windows Server 2016
- some of the wizard pages and dialog tab names have changed across versions of Windows Server 
- for a guide written for Windows Server 2012, the [Pagerduty SSO integration guide](https://www.pagerduty.com/docs/guides/adfs-sso-guide/) is very similar to Buildkite
- you can follow the pagerduty instructions, and subsitute in the Buildkite values from the instructions below

### Add a Relying Party Trust

From the `Actions` sidebar, choose `add relying party trust...` to start the wizard

1. Welcome: select `Claims aware`
1. Select data source: select `Enter data about the relying party manually`
1. Specify display name: call your relying party `Buildkite`
1. Choose profile: select `AD FS profile`
1. Configure certificate: skip this step, as you don't need a token encryption certificate
1. Configure URL: 
	select `Enable support for the SAML 2.0 WebSSO protocol` 
	replace <slug> with your organisation slug in this URL: https://buildkite.com/login/sso/saml/consume?organization=<slug>
	enter that URL as your `Relying party SAML 2.0 SSO service URL` 
1. Configure identifiers: 
	enter `https://buildkite.com` into the `Relying party trust identifier` field
	click `add` to add it to the `Relying party trust identifiers` list
1. Choose Access Control Policy:
	choose `Permit everyone`
	you can choose to select specific users, but that will involve further steps that aren't covered by this guide
1. Ready to add trust: review your settings to make sure all the urls are correct
1. Finish:
	leave the `configure claims issuance policy for this application` box checked
	click `close` to close the wizard and save your setup

In the `Actions` sidebar, you should now have a subheading `Buildkite`. 

### Add an issuance transform rule

From the `Buildkite` section of the `Actions` sidebar, select `Edit claim issuance policy...`

- we'll be adding three rules
- on the Issuance transform rules tab: click `add rule`

Rule 1
1. Choose rule type: `Send LDAP Attributes as claims`
1. Configure claim rule:
	Claim Rule Name: Get Attributes
	Attribute Store: Active Directory
	Mapping of LDAP Attributes to outgoing claim types:
		LDAP Attribute: Email Addresses, Outgoing claim type: Email address
		LDAP Attribute: Display-Name, Outgoing claim type: Name
1. Click `Finish` to add the rule

Rule 2
1. Choose rule type: `Transform an incoming claim`
1. Configure claim rule:
	Claim Rule Name: Name ID Transform
	Incoming Claim Type: Email address
	Outgoing Claim Type: Name ID
	Outgoing Name ID Format: Email
	Select `Pass through all claim values`
1. Click `Finish` to add the rule

Rule 3
1. Choose rule type: `Send claims using a custom rule`
1. Configure claim rule:
	Claim Rule Name: 'Name' Attribute Name Transform
	Custom Rule: 
```
c:[Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"]
 => issue(Type = "Name", Issuer = c.Issuer, OriginalIssuer = c.OriginalIssuer, Value = c.Value, ValueType = c.ValueType);
```
1. Click `Finish` to add the rule
1. Click `OK` to save and exit the Claim Issuance Policy dialog

### Export the token signing certificate



### Update the authentication policy

### What the Buildkite team will do
1. enable sso for the specified organisation
1. get you to test that it's all working
1. force a logout for all the users in the organisation, so that everyone will log in via Okta next time they access Buildkite.com



